
 make.py started: 2021-02-13 17:19:59 C:\Users\shermo\Documents\GitHub\min_wage_rent\base\safmr\code 




Execute:  StataMP-64 /e do "./build_zipcode.do"

  ___  ____  ____  ____  ____ (R)
 /__    /   ____/   /   ____/
___/   /   /___/   /   /___/   15.1   Copyright 1985-2017 StataCorp LLC
  Statistics/Data Analysis            StataCorp
                                      4905 Lakeway Drive
     MP - Parallel Edition            College Station, Texas 77845 USA
                                      800-STATA-PC        http://www.stata.com
                                      979-696-4600        stata@stata.com
                                      979-696-4601 (fax)

Single-user 32-core Stata perpetual license:
       Serial number:  501506205566
         Licensed to:  KU Leuven FEB (CES)
                       KU Leuven

Notes:
      1.  Stata is running in batch mode.
      2.  Unicode is supported; see help unicode_advice.
      3.  More than 2 billion observations are allowed; see help obs_advice.
      4.  Maximum number of variables is set to 5000; see help set_maxvar.

. do ./build_zipcode.do 

. set more off

. clear all

. adopath + ../../../lib/stata/gslab_misc/ado
  [1]  (BASE)      "C:\Program Files\Stata15\ado\base/"
  [2]  (SITE)      "C:\Program Files\Stata15\ado\site/"
  [3]              "."
  [4]  (PERSONAL)  "c:\ado\personal/"
  [5]  (PLUS)      "c:\ado\plus/"
  [6]  (OLDPLACE)  "c:\ado/"
  [7]              "../../../lib/stata/gslab_misc/ado"

. 
. program main 
  1.         local raw     "../../../drive/raw_data/"
  2.         local outstub "../output/"
  3.         local temp    "../temp"
  4. 
.         prepare_data, instub(`raw')
  5. 
.         forval fmr = 2018(-1)2012 {
  6.                 append using ../temp/safmrs_`fmr'.dta
  7.         }
  8. 
.         drop if missing(zipcode)
  9.         sort zipcode year
 10. 
.         drop if zipcode < 1000 
 11. 
.         duplicates drop
 12. 
.         save_data `outstub'safrm.dta, key(zipcode year) replace
 13. end

. 
. 
. program prepare_data
  1.         syntax, instub(str) 
  2. 
.         forval fmr = 2018(-1)2016 {
  3.                 import excel `instub'SFMR/fy`fmr'_safmrs.xlsx, first clear
>       
  4.                 clean_safmrs, yr(`fmr') instub(`instub')
  5.                 save ../temp/safmrs_`fmr'.dta, replace
  6.         }       
  7. 
.         forval fmr = 2015(-1)2012 {
  8.                 import excel `instub'SFMR/fy`fmr'_safmrs.xls, first clear 
  9.                 clean_safmrs, yr(`fmr') instub(`instub')
 10.                 save ../temp/safmrs_`fmr'.dta, replace
 11.         }
 12. 
.         import excel `instub'SFMR/fy2019_safmrs_rev.xlsx, first clear 
 13.         clean_safmrs, yr(2019) instub(`instub')
 14. end

. 
. program clean_safmrs 
  1.         syntax, yr(int) instub(str)
  2. 
.         if `yr' == 2012 | `yr' == 2013 | `yr' == 2014 {
  3.                 tolower State StateName County CountyName CBSA CBSAName ZI
> P
  4.                 rename (state statename county countyname zip) (state_fips
>  state county_fips county zipcode)
  5. 
.                 bys state_fips county_fips (county): replace county = county[
> _N]  
  6.                 replace county = "Broomfield" if state_fips=="08" & county
> _fips=="014"
  7.                 bys state_fips cbsa (cbsaname): replace cbsaname = cbsanam
> e[_N]  
  8. 
.                 replace county_fips = state_fips + county_fips               
>    
  9.                 replace county = subinstr(county, " County", "", .)
 10.                 destring county_fips, replace 
 11.                 labmask county_fips, values(county)
 12.                 drop county
 13. 
.                 destring state_fips, replace 
 14.                 drop if state_fips == 72
 15.                 if `yr'== 2012 {
 16.                         replace state_fips = 1  if state == "Alabama"
 17.                         replace state_fips = 10 if state == "Delaware"
 18.                         replace state_fips = 25 if state == "Massachusetts
> "
 19.                         replace state_fips = 54 if state == "West Virginia
> "
 20.                 }
 21.                 labmask state_fips, values(state)
 22.                 drop state
 23. 
.                 labmask cbsa, values(cbsaname)
 24.                 drop cbsaname   
 25. 
.                 if `yr'== 2012 {
 26.                         gen byte notnumeric = (real(zipcode) == .)
 27.                         drop if notnum == 1 
 28.                         drop notnum
 29.                 }
 30.                 destring zipcode, replace
 31. 
.                 duplicates drop
 32. 
.                 rename area_rent_* safmrs*
 33.                 forval x = 0(1)4 {
 34.                         rename safmrsbr`x' safmr`x'br
 35.                 }
 36. 
.                 if `yr'== 2013 {
 37.                         duplicates drop zipcode county_fips, force
 38.                 }
 39.         }
 40. 
.         if `yr' == 2015 {
 41.                 rename (state statename county cntyname cbsamet cbnsmcnm) 
> ///
>                                 (state_fips state county_fips county cbsa cbs
> aname)
 42. 
.                 bys state_fips county_fips (county): replace county = county[
> _N]  
 43.                 replace county = "Broomfield" if state_fips=="08" & county
> _fips=="014"
 44. 
.                 bys state_fips cbsa (cbsaname): replace cbsaname = cbsaname[_
> N]  
 45.                 replace county_fips = state_fips + county_fips            
>       
 46.                 replace county = subinstr(county, " County", "", .)
 47.                 destring county_fips, replace 
 48.                 labmask county_fips, values(county)
 49.                 drop county
 50. 
.                 destring state_fips, replace 
 51.                 labmask state_fips, values(state)
 52.                 drop if state_fips==72
 53.                 drop state
 54. 
.                 destring cbsa, replace 
 55.                 labmask cbsa, values(cbsaname)
 56.                 drop cbsaname
 57. 
.                 destring zipcode, replace
 58.                 drop if missing(zipcode)
 59. 
.                 duplicates drop
 60. 
.                 rename area_rent_* safmrs*
 61.                 forval x = 0(1)4 {
 62.                         rename safmrsbr`x' safmr`x'br
 63.                 }
 64.         }
 65. 
.         if `yr'==2016 {
 66.                 rename(zip_code metro_code metro_name fips_state_code stat
> ename  fips_county_code county_name) ///
>                                 (zipcode cbsa cbsaname state_fips state count
> y_fips countyname)
 67. 
.                 bys state_fips county_fips (countyname): replace countyname =
>  countyname[_N]  
 68.                 replace countyname = "Broomfield" if state_fips=="08" & co
> unty_fips=="014"
 69.                 bys state_fips cbsa (cbsaname): replace cbsaname = cbsanam
> e[_N]  
 70. 
.                 replace county_fips = state_fips + county_fips               
>    
 71.                 replace countyname = subinstr(countyname, " County", "", .
> )
 72.                 destring county_fips, replace 
 73.                 labmask county_fips, values(countyname)
 74.                 drop countyname
 75. 
.                 destring state_fips, replace 
 76.                 labmask state_fips, values(state)
 77.                 drop if state_fips==72
 78.                 drop state
 79. 
.                 destring cbsa, replace 
 80.                 labmask cbsa, values(cbsaname)
 81.                 drop cbsaname
 82. 
.                 destring zipcode, replace
 83. 
.                 duplicates drop
 84. 
.                 rename area_rent_* safmrs*
 85.                 forval x = 0(1)4 {
 86.                         rename safmrsbr`x' safmr`x'br
 87.                 }
 88.         }
 89. 
.         if `yr'== 2017 {
 90.                 rename (zip_code metro_code metro_name) (zipcode cbsa cbsa
> name) 
 91.                 destring cbsa, replace 
 92.                 labmask cbsa, values(cbsaname)
 93.                 drop cbsaname 
 94. 
.                 destring zipcode, replace
 95. 
.                 duplicates drop
 96. 
.                 rename area_rent_* safmrs*
 97.                 forval x = 0(1)4 {
 98.                         rename safmrsbr`x' safmr`x'br
 99.                 }
100.         }
101. 
.         if `yr' == 2018 | `yr' == 2019 {
102.                 tolower *
103.                 rename (hudmetrofairmarketrentarea) (hudname)
104.                         
.                 rename (*paymentstandard *paymentstandar) (*pct *pct) 
105. 
.                 g hudcode = substr(hudareacode, -6, 6)
106.                 g cbsa = substr(hudareacode, 1, 10)
107.                 replace cbsa = subinstr(cbsa, "METRO", "", .)
108.                 destring cbsa, replace
109.                         
.                 drop hudareacode
110. 
.                 destring zipcode, replace
111.                 drop if missing(zipcode)
112.                         
.                 drop hudname hudcode
113.                 duplicates drop
114. 
.                 drop safmr*pct
115.         }
116.                 
.         collapse_zipcodes, instub(`instub') yr(`yr')
117. 
.         gen year =`yr'
118.                         
.         order year zipcode safmr*
119. end 

. 
. 
. program collapse_zipcodes 
  1.         syntax, yr(int) instub(str)
  2.         
.         if `yr' < 2017 {
  3.                 preserve 
  4.                         import excel ../../../raw/crosswalk/ZIP_COUNTY_12`
> yr'.xlsx, clear first
  5.                         cap tolower *
  6.                         rename (zip county) (zipcode county_fips) 
  7.                         destring zipcode, replace 
  8.                         destring county_fips, replace
  9.                         keep zipcode county_fips res_ratio 
 10.                         isid zipcode county_fips
 11.                         tempfile countyxwalk_`yr'
 12.                         save "`countyxwalk_`yr''", replace
 13.                 restore  
 14. 
.                 merge 1:1 zipcode county_fips using `countyxwalk_`yr'', nogen
>  assert(1 2 3) keep(1 3)
 15.                 keep if res_ratio>.5 | missing(res_ratio)
 16.                 duplicates tag cbsa zipcode, g(dup)
 17.                 drop if dup>=1 & missing(res_ratio)
 18.                 
.                 isid cbsa zipcode 
 19. 
.                 drop res_ratio dup
 20.                 keep zipcode cbsa safmr*                
 21.         }
 22. 
.         preserve
 23.                 import excel ../../../raw/crosswalk/ZIP_CBSA_12`yr'.xlsx, 
> clear first
 24.                 cap tolower *
 25.                 rename zip zipcode 
 26.                 destring zipcode cbsa, replace
 27.                 keep zipcode cbsa res_ratio 
 28.                 tempfile xwalk_`yr'
 29.                 save "`xwalk_`yr''", replace
 30.         restore 
 31. 
.         merge 1:1 zipcode cbsa using `xwalk_`yr'', nogen assert(1 2 3) keep(1
>  3) 
 32. 
.         bys zipcode (cbsa): egen totwgt = sum(res_ratio)
 33.         bys zipcode (cbsa): g missing_wgt = 1 - totwgt
 34.         bys zipcode (cbsa): egen temp_mis = count(res_ratio) if missing(re
> s_ratio)
 35.         bys zipcode (cbsa): egen n_mis = sum(res_ratio==.)
 36.         g new_wgt = res_ratio
 37.         bys zipcode (cbsa): replace new_wgt = missing_wgt / n_mis if missi
> ng(res_ratio)
 38. 
.         drop res_ratio totwgt missing_wgt n_mis
 39. 
.         collapse (mean) safmr* [w = new_wgt], by(zipcode)
 40. end

. 
. * Execute
. main
(1 missing value generated)
(1 missing value generated)
(25,838 real changes made)
cbsa: all characters numeric; replaced as long
(1 missing value generated)
zipcode: all characters numeric; replaced as long
(1 missing value generated)
(1 observation deleted)

Duplicates in terms of all variables

(942 observations deleted)
zipcode: all characters numeric; replaced as long
cbsa: all characters numeric; replaced as long
(note: file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000002.tmp not found)
file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000002.tmp saved

    Result                           # of obs.
    -----------------------------------------
    not matched                           331
        from master                       331  
        from using                          0  

    matched                            24,565  
    -----------------------------------------
(24565 missing values generated)
(331 missing values generated)
(331 real changes made)
(analytic weights assumed)
(note: file ../temp/safmrs_2018.dta not found)
file ../temp/safmrs_2018.dta saved
cbsa: all characters numeric; replaced as long
zipcode: all characters numeric; replaced as long

Duplicates in terms of all variables

(0 observations are duplicates)
zipcode: all characters numeric; replaced as long
cbsa: all characters numeric; replaced as long
(note: file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000002.tmp not found)
file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000002.tmp saved

    Result                           # of obs.
    -----------------------------------------
    not matched                           312
        from master                       312  
        from using                          0  

    matched                            24,454  
    -----------------------------------------
(24454 missing values generated)
(312 missing values generated)
(312 real changes made)
(analytic weights assumed)
(note: file ../temp/safmrs_2017.dta not found)
file ../temp/safmrs_2017.dta saved
(0 real changes made)
(7 real changes made)
(0 real changes made)
variable county_fips was str3 now str5
(27,000 real changes made)
(25,847 real changes made)
county_fips: all characters numeric; replaced as long
state_fips: all characters numeric; replaced as byte
(235 observations deleted)
cbsa: all characters numeric; replaced as long
zipcode: all characters numeric; replaced as long

Duplicates in terms of all variables

(0 observations are duplicates)
zipcode: all characters numeric; replaced as long
county_fips: all characters numeric; replaced as long
(note: file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000002.tmp not found)
file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000002.tmp saved

    Result                           # of obs.
    -----------------------------------------
    not matched                           373
        from master                       373  
        from using                          0  

    matched                            26,392  
    -----------------------------------------
(5,921 observations deleted)

Duplicates in terms of cbsa zipcode
(43 observations deleted)
zipcode: all characters numeric; replaced as long
cbsa: all characters numeric; replaced as long
(note: file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000004.tmp not found)
file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000004.tmp saved

    Result                           # of obs.
    -----------------------------------------
    not matched                         4,701
        from master                     4,701  
        from using                          0  

    matched                            16,100  
    -----------------------------------------
(16100 missing values generated)
(4,701 missing values generated)
(4701 real changes made)
(analytic weights assumed)
(note: file ../temp/safmrs_2016.dta not found)
file ../temp/safmrs_2016.dta saved
(0 real changes made)
(6 real changes made)
(6 real changes made)
variable county_fips was str3 now str5
(22,784 real changes made)
(21,947 real changes made)
county_fips: all characters numeric; replaced as long
state_fips: all characters numeric; replaced as byte
(141 observations deleted)
cbsa: all characters numeric; replaced as long
zipcode: all characters numeric; replaced as long
(3 missing values generated)
(3 observations deleted)

Duplicates in terms of all variables

(28 observations deleted)
zipcode: all characters numeric; replaced as long
county_fips: all characters numeric; replaced as long
(note: file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000002.tmp not found)
file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000002.tmp saved

    Result                           # of obs.
    -----------------------------------------
    not matched                           274
        from master                       274  
        from using                          0  

    matched                            22,338  
    -----------------------------------------
(4,331 observations deleted)

Duplicates in terms of cbsa zipcode
(12 observations deleted)
zipcode: all characters numeric; replaced as long
cbsa: all characters numeric; replaced as long
(note: file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000004.tmp not found)
file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000004.tmp saved

    Result                           # of obs.
    -----------------------------------------
    not matched                         4,532
        from master                     4,532  
        from using                          0  

    matched                            13,737  
    -----------------------------------------
(13737 missing values generated)
(4,532 missing values generated)
(4532 real changes made)
(analytic weights assumed)
(note: file ../temp/safmrs_2015.dta not found)
file ../temp/safmrs_2015.dta saved
(0 real changes made)
(6 real changes made)
(6 real changes made)
variable county_fips was str3 now str5
(24,160 real changes made)
(23,263 real changes made)
county_fips: all characters numeric; replaced as long
state_fips: all characters numeric; replaced as byte
(140 observations deleted)
zipcode: all characters numeric; replaced as long

Duplicates in terms of all variables

(52 observations deleted)
zipcode: all characters numeric; replaced as long
county_fips: all characters numeric; replaced as long
(note: file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000002.tmp not found)
file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000002.tmp saved

    Result                           # of obs.
    -----------------------------------------
    not matched                           306
        from master                       306  
        from using                          0  

    matched                            23,662  
    -----------------------------------------
(4,469 observations deleted)

Duplicates in terms of cbsa zipcode
(14 observations deleted)
zipcode: all characters numeric; replaced as long
cbsa: all characters numeric; replaced as long
(note: file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000004.tmp not found)
file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000004.tmp saved

    Result                           # of obs.
    -----------------------------------------
    not matched                         4,839
        from master                     4,839  
        from using                          0  

    matched                            14,646  
    -----------------------------------------
(14646 missing values generated)
(4,839 missing values generated)
(4839 real changes made)
(analytic weights assumed)
(note: file ../temp/safmrs_2014.dta not found)
file ../temp/safmrs_2014.dta saved
(0 real changes made)
(6 real changes made)
(6 real changes made)
variable county_fips was str3 now str5
(24,147 real changes made)
(23,249 real changes made)
county_fips: all characters numeric; replaced as long
state_fips: all characters numeric; replaced as byte
(168 observations deleted)
zipcode: all characters numeric; replaced as long

Duplicates in terms of all variables

(0 observations are duplicates)

Duplicates in terms of zipcode county_fips

(1 observation deleted)
zipcode: all characters numeric; replaced as long
county_fips: all characters numeric; replaced as long
(note: file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000002.tmp not found)
file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000002.tmp saved

    Result                           # of obs.
    -----------------------------------------
    not matched                           404
        from master                       404  
        from using                          0  

    matched                            23,574  
    -----------------------------------------
(4,531 observations deleted)

Duplicates in terms of cbsa zipcode
(19 observations deleted)
zipcode: all characters numeric; replaced as long
cbsa: all characters numeric; replaced as long
(note: file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000004.tmp not found)
file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000004.tmp saved

    Result                           # of obs.
    -----------------------------------------
    not matched                         4,902
        from master                     4,902  
        from using                          0  

    matched                            14,526  
    -----------------------------------------
(14526 missing values generated)
(4,902 missing values generated)
(4902 real changes made)
(analytic weights assumed)
(note: file ../temp/safmrs_2013.dta not found)
file ../temp/safmrs_2013.dta saved
(54 real changes made)
(6 real changes made)
(6 real changes made)
variable county_fips was str3 now str5
(23,691 real changes made)
(22,740 real changes made)
county_fips: all characters numeric; replaced as long
state_fips: all characters numeric; replaced as byte
(231 observations deleted)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(35 observations deleted)
zipcode: all characters numeric; replaced as long

Duplicates in terms of all variables

(0 observations are duplicates)
zipcode: all characters numeric; replaced as long
county_fips: all characters numeric; replaced as long
(note: file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000002.tmp not found)
file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000002.tmp saved

    Result                           # of obs.
    -----------------------------------------
    not matched                           907
        from master                       907  
        from using                          0  

    matched                            22,518  
    -----------------------------------------
(6,142 observations deleted)

Duplicates in terms of cbsa zipcode
(239 observations deleted)
zipcode: all characters numeric; replaced as long
cbsa: all characters numeric; replaced as long
(note: file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000004.tmp not found)
file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000004.tmp saved

    Result                           # of obs.
    -----------------------------------------
    not matched                         4,024
        from master                     4,024  
        from using                          0  

    matched                            13,020  
    -----------------------------------------
(13020 missing values generated)
(4,024 missing values generated)
(4024 real changes made)
(analytic weights assumed)
(note: file ../temp/safmrs_2012.dta not found)
file ../temp/safmrs_2012.dta saved
(26,019 real changes made)
cbsa: all characters numeric; replaced as long
zipcode: all characters numeric; replaced as long
(0 observations deleted)

Duplicates in terms of all variables

(988 observations deleted)
zipcode: all characters numeric; replaced as long
cbsa: all characters numeric; replaced as long
(note: file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000002.tmp not found)
file C:\Users\shermo\AppData\Local\Temp\17\ST_4938_000002.tmp saved

    Result                           # of obs.
    -----------------------------------------
    not matched                           844
        from master                       844  
        from using                          0  

    matched                            24,187  
    -----------------------------------------
(24187 missing values generated)
(844 missing values generated)
(844 real changes made)
(analytic weights assumed)
(0 observations deleted)
(483 observations deleted)

Duplicates in terms of all variables

(0 observations are duplicates)
(data already sorted by zipcode year)
  variable year was float now int
  (323,762 bytes saved)
===============================================================================
File: ../output/safrm.dta
Key: zipcode year
===============================================================================
  161881:7(32277):961095122:1415907161

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
     zipcode |    161,881    48588.15    29137.73       1001      99999
        year |    161,881    2015.707    2.280058       2012       2019
    safmr0br |    161,881    714.0648    288.9286        330       3130
    safmr1br |    161,881    817.5096    321.9903        370       3840
    safmr2br |    161,881    1011.945    387.7483        490       4760
-------------+---------------------------------------------------------
    safmr3br |    161,881    1353.448    521.1004        620       6240
    safmr4br |    161,881    1571.448    619.9266        650       7250




(note: file ../output/safrm.dta not found)
file ../output/safrm.dta saved

. 
end of do-file

 make.py ended: 2021-02-13 17:21:40
