
 make.py started: 2022-03-18 09:14:10 C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\code 




Execute:  R CMD BATCH --no-save "./plot_events.R" plot_events.Rout

R version 4.1.1 (2021-08-10) -- "Kick Things"
Copyright (C) 2021 The R Foundation for Statistical Computing
Platform: x86_64-w64-mingw32/x64 (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> remove(list = ls())
> 
> library(sf)
Linking to GEOS 3.9.1, GDAL 3.2.1, PROJ 7.2.1
> library(dplyr)

Attaching package: 'dplyr'

The following objects are masked from 'package:stats':

    filter, lag

The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union

> library(spData)
To access larger datasets in this package, install the spDataLarge
package with: `install.packages('spDataLarge',
repos='https://nowosad.github.io/drat/', type='source')`
> library(tmap)
> library(tmaptools)
> library(leaflet)
> library(ggplot2)
> 
> main <- function(){
+   in_map  <- "../../../drive/raw_data/shapefiles/USPS_zipcodes"
+   in_data <- "../../../drive/derived_large/estimation_samples"
+   
+   df_all <- prepare_data(in_map, in_data)
+   
+   events <- list(list("chicago",   16980, 2019, 6, 2019, 12),
+                  list("san_diego", 41740, 2018, 12, 2019, 6),
+                  list("seattle",   42660, 2018, 12, 2019, 6),
+                  list("nyc",       35620, 2018, 12, 2019, 6),
+                  list("kc",        28140, 2018, 12, 2019, 6),
+                  list("bay_area",  41860, 2018, 12, 2019, 6))
+                  # Name cbsa, Code cbsa, start date, end date
+   
+   lapply(events,
+     function(event) {
+       df <- restrict_and_build_changes(df_all, event[[2]],
+                                        event[[3]], event[[4]], event[[5]], event[[6]]) 
+       max_break_mw    <- round(max(df$change_ln_statutory_mw, na.rm = TRUE), digits = 2)
+       max_break_rents <- round(max(df$change_ln_rents, na.rm = TRUE), digits = 2)
+       
+       build_map(df, "change_ln_statutory_mw", "Change in\nresidence MW", 
+                 c(0, max_break_mw/2, max_break_mw), 
+                 paste0(event[[1]], "_", event[[3]], "-", event[[4]], "_statutory_mw"))
+       build_map(df, "change_exp_ln_mw", "Change in\nworkplace MW", 
+                 c(0, max_break_mw/2, max_break_mw), 
+                 paste0(event[[1]], event[[3]], "-", event[[4]], "_exp_mw"))
+       build_map(df, "change_ln_rents", "Change in\nlog(rents)",
+                 c(0, max_break_rents/2, max_break_rents),
+                 paste0(event[[1]], event[[3]], "-", event[[4]], "_rents"))
+     }
+   ) -> l
+ }
> 
> prepare_data <- function(in_map, in_data) {
+   
+   USPS_zipcodes <- read_sf(dsn = in_map, 
+                            layer = "USPS_zipcodes_July2020") %>%
+     select(ZIP_CODE, PO_NAME, STATE, POPULATION, SQMI, POP_SQMI) %>%
+     rename(zipcode = ZIP_CODE, zipcode_name = PO_NAME,
+            state_name = STATE, pop2020 = POPULATION, 
+            area_sq_miles = SQMI, pop2020_per_sq_miles = POP_SQMI)
+   
+   mw_rent_data <- data.table::fread(file.path(in_data, "zipcode_months.csv"),
+                                     colClasses = c(zipcode ="character", 
+                                                    cbsa = "character", statefips = "character")) %>%
+     select(zipcode, cbsa, year, month, statutory_mw, 
+            mw_wkp_tot_17, medrentpricepsqft_SFCC) %>%
+     mutate(ln_statutory_mw = log(statutory_mw),
+            ln_rent_var  = log(medrentpricepsqft_SFCC))
+   
+   left_join(USPS_zipcodes, mw_rent_data, by = "zipcode")
+ }
> 
> restrict_and_build_changes <- function(data, cbsa_code, year_lb, month_lb, 
+                                        year_ub, month_ub){
+   data %>%
+     filter(cbsa == cbsa_code) %>%
+     filter(  (year == year_lb & month == month_lb) 
+            | (year == year_ub & month == month_ub)) %>%
+     group_by(zipcode) %>%
+     summarise(change_statutory_mw    = last(statutory_mw)   - first(statutory_mw), 
+               change_ln_statutory_mw = last(ln_statutory_mw) - first(ln_statutory_mw),
+               change_exp_ln_mw    = last(mw_wkp_tot_17)   - first(mw_wkp_tot_17),
+               change_ln_rents     = last(ln_rent_var) - first(ln_rent_var)) %>%
+     ungroup()
+ }
> 
> build_map <- function(data, var, var_legend, break_values,
+                       map_name, .dpi = 250){
+   
+   map <- tm_shape(data) + 
+     tm_fill(col = var,
+             title = var_legend,
+             style = "cont",
+             palette = c("#A6E1F4", "#077187"),
+             breaks = break_values,
+             textNA = "NA") +
+     tm_borders(col = "white", lwd = .01, alpha = 0.7) +
+     tm_layout(legend.position = c("left", "bottom"),
+     	      frame = FALSE)
+   
+   tmap_save(map, 
+             paste0("../output/", map_name, ".png"),
+             dpi = .dpi)
+   tmap_save(map, 
+             paste0("../output/", map_name, ".eps"))
+ }
> 
> main()
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\chicago_2019-6_statutory_mw.png
Resolution: 1377.356 by 2223.462 pixels
Size: 5.509426 by 8.893849 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\chicago_2019-6_statutory_mw.eps
Size: 5.509426 by 8.893849 inches
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\chicago2019-6_exp_mw.png
Resolution: 1377.356 by 2223.462 pixels
Size: 5.509426 by 8.893849 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\chicago2019-6_exp_mw.eps
Size: 5.509426 by 8.893849 inches
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\chicago2019-6_rents.png
Resolution: 1377.356 by 2223.462 pixels
Size: 5.509426 by 8.893849 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\chicago2019-6_rents.eps
Size: 5.509426 by 8.893849 inches
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\san_diego_2018-12_statutory_mw.png
Resolution: 1378.769 by 2221.184 pixels
Size: 5.515078 by 8.884734 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\san_diego_2018-12_statutory_mw.eps
Size: 5.515078 by 8.884734 inches
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\san_diego2018-12_exp_mw.png
Resolution: 1378.769 by 2221.184 pixels
Size: 5.515078 by 8.884734 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\san_diego2018-12_exp_mw.eps
Size: 5.515078 by 8.884734 inches
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\san_diego2018-12_rents.png
Resolution: 1378.769 by 2221.184 pixels
Size: 5.515078 by 8.884734 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\san_diego2018-12_rents.eps
Size: 5.515078 by 8.884734 inches
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\seattle_2018-12_statutory_mw.png
Resolution: 1195.646 by 2561.377 pixels
Size: 4.782583 by 10.24551 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\seattle_2018-12_statutory_mw.eps
Size: 4.782583 by 10.24551 inches
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\seattle2018-12_exp_mw.png
Resolution: 1195.646 by 2561.377 pixels
Size: 4.782583 by 10.24551 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\seattle2018-12_exp_mw.eps
Size: 4.782583 by 10.24551 inches
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\seattle2018-12_rents.png
Resolution: 1195.646 by 2561.377 pixels
Size: 4.782583 by 10.24551 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\seattle2018-12_rents.eps
Size: 4.782583 by 10.24551 inches
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\nyc_2018-12_statutory_mw.png
Resolution: 1826.276 by 1676.91 pixels
Size: 7.305105 by 6.707638 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\nyc_2018-12_statutory_mw.eps
Size: 7.305105 by 6.707638 inches
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\nyc2018-12_exp_mw.png
Resolution: 1826.276 by 1676.91 pixels
Size: 7.305105 by 6.707638 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\nyc2018-12_exp_mw.eps
Size: 7.305105 by 6.707638 inches
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\nyc2018-12_rents.png
Resolution: 1826.276 by 1676.91 pixels
Size: 7.305105 by 6.707638 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\nyc2018-12_rents.eps
Size: 7.305105 by 6.707638 inches
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\kc_2018-12_statutory_mw.png
Resolution: 1865.858 by 1641.336 pixels
Size: 7.463433 by 6.565343 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\kc_2018-12_statutory_mw.eps
Size: 7.463433 by 6.565343 inches
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\kc2018-12_exp_mw.png
Resolution: 1865.858 by 1641.336 pixels
Size: 7.463433 by 6.565343 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\kc2018-12_exp_mw.eps
Size: 7.463433 by 6.565343 inches
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\kc2018-12_rents.png
Resolution: 1865.858 by 1641.336 pixels
Size: 7.463433 by 6.565343 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\kc2018-12_rents.eps
Size: 7.463433 by 6.565343 inches
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\bay_area_2018-12_statutory_mw.png
Resolution: 1895.344 by 1615.802 pixels
Size: 7.581375 by 6.463208 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\bay_area_2018-12_statutory_mw.eps
Size: 7.581375 by 6.463208 inches
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\bay_area2018-12_exp_mw.png
Resolution: 1895.344 by 1615.802 pixels
Size: 7.581375 by 6.463208 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\bay_area2018-12_exp_mw.eps
Size: 7.581375 by 6.463208 inches
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\bay_area2018-12_rents.png
Resolution: 1895.344 by 1615.802 pixels
Size: 7.581375 by 6.463208 inches (250 dpi)
Map saved to C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\maps_events\output\bay_area2018-12_rents.eps
Size: 7.581375 by 6.463208 inches
There were 50 or more warnings (use warnings() to see the first 50)
> 
> proc.time()
   user  system elapsed 
  69.46   32.04  102.57 

 make.py ended: 2022-03-18 09:15:53
