
 make.py started: 2021-10-27 14:27:05 C:\Users\diegog\Desktop\Diego\min_wage_rent\analysis\zillow_benchmark\code 




Execute:  StataMP-64 /e do "./compare_zillow_zipcode.do"

  ___  ____  ____  ____  ____ (R)
 /__    /   ____/   /   ____/
___/   /   /___/   /   /___/   15.1   Copyright 1985-2017 StataCorp LLC
  Statistics/Data Analysis            StataCorp
                                      4905 Lakeway Drive
     MP - Parallel Edition            College Station, Texas 77845 USA
                                      800-STATA-PC        http://www.stata.com
                                      979-696-4600        stata@stata.com
                                      979-696-4601 (fax)

Single-user 32-core Stata perpetual license:
       Serial number:  501506205566
         Licensed to:  KU Leuven FEB (CES)
                       KU Leuven

Notes:
      1.  Stata is running in batch mode.
      2.  Unicode is supported; see help unicode_advice.
      3.  More than 2 billion observations are allowed; see help obs_advice.
      4.  Maximum number of variables is set to 5000; see help set_maxvar.

. do ./compare_zillow_zipcode.do 

. clear all

. set more off

. adopath + ../../../lib/stata/gslab_misc/ado
  [1]  (BASE)      "C:\Program Files\Stata15\ado\base/"
  [2]  (SITE)      "C:\Program Files\Stata15\ado\site/"
  [3]              "."
  [4]  (PERSONAL)  "c:\ado\personal/"
  [5]  (PLUS)      "c:\ado\plus/"
  [6]  (OLDPLACE)  "c:\ado/"
  [7]              "../../../lib/stata/gslab_misc/ado"

. set maxvar 32000 


. 
. program main 
  1.         local instub_zillow "../../../drive/derived_large/estimation_sampl
> es"
  2.         local instub_safmr "../../../base/safmr/output"
  3.         local logfile "../output/data_file_manifest.log"
  4.         
.         import delim "../../../drive/raw_data/census/cpi2012_usa.csv", clear 
>  
  5.         replace cpi2012 = cpi2012 /100
  6.         save ../temp/cpi2012.dta, replace
  7. 
.         import delim "../../../drive/raw_data/ahs/AHS_sfcc_est_by_br.csv", cl
> ear
  8.         prepare_ahs_weights
  9.         save ../temp/ahs_wgt.dta, replace 
 10.         
.         use "`instub_safmr'/safrm_2017_2019_by_zipcode_cbsa10.dta", clear
 11.         collapse (sum) safmr1br safmr2br safmr3br safmr4br, ///
>             by(zipcode year)
 12.         save "../temp/safmr_2017_2019.dta", replace
 13.         
.         use "`instub_safmr'/safrm_2012_2016_by_zipcode_county_cbsa10.dta", cl
> ear
 14.         collapse (sum) safmr1br safmr2br safmr3br safmr4br, ///
>             by(zipcode year)
 15.         append using "../temp/safmr_2017_2019.dta"
 16.         save "../temp/safmr.dta", replace
 17.         prepare_weighted_safmr
 18.         save ../temp/wgt_safmr.dta, replace 
 19. 
.         compare_zillow_safmr_zipcode, inzillow(`instub_zillow') ///
>             mlist(1 6 12)
 20.         drop _merge
 21.         reshape wide medrentprice_SFCC safmrbr, i(zipcode safmr_type) j(ye
> ar)
 22.         gen chg_safmrbr = safmrbr2019 - safmrbr2018
 23.         gen chg_medrent_price = medrentprice_SFCC2019 - medrentprice_SFCC2
> 018
 24.         
.         binscatter chg_medrent_price chg_safmrbr if safmr_type == 2
 25.         graph export "../output/binscatter_zillow_vs_safmr2br.png", replac
> e
 26. end 

. 
. program prepare_ahs_weights
  1.         
.         collapse (sum) estimate, by(year br)
  2.         bys year: egen tot_house = sum(estimate)
  3.         g br_share = estimate / tot_house
  4. 
.         keep year br br_share
  5. 
.         tsset br year 
  6.         tsfill
  7.         bys br: carryforward br_share, replace 
  8. end 

. 
. program prepare_weighted_safmr
  1.         unab safmrvars: safmr*
  2.         collapse (mean) `safmrvars', by(year)
  3.         reshape long safmr@br, i(year) j(br)
  4.         rename safmrbr safmr
  5.         merge 1:1 year br using "../temp/ahs_wgt.dta", nogen assert(1 2 3)
>  keep(1 3)
  6.         collapse (mean) safmr [w = br_share], by(year)
  7. end 

. 
. 
. program compare_zillow_safmr_zipcode
  1.         syntax, inzillow(str) mlist(str)
  2.         
.         use zipcode place_code cbsa10 countyfips statefips ///
>                 year_month medrentprice_SFCC ///
>                 using "`inzillow'/all_zipcode_months.dta"
  3. 
.         g rmtag = (medrentprice_SFCC == .)
  4.         bys zipcode (year_month): g ziplen = _N
  5.         bys zipcode (year_month): gegen rmcount = sum(rmtag)
  6.         g sample_SFCC = (ziplen != rmcount)
  7.         drop ziplen rmtag rmcount
  8. 
.         unab samplist: sample_*
  9.         gegen allmis = rowtotal(`samplist')
 10.         drop if allmis==0 
 11.         drop allmis 
 12.         g year = yofd(dofm(year_month))
 13.         keep if inrange(year, 2010, 2019)
 14. 
.         preserve
 15.         collapse (mean) medrentprice_SFCC, by(year)
 16.         merge 1:1 year using ../temp/wgt_safmr.dta, nogen assert(1 2 3) ke
> ep(1 3)
 17. 
.         merge 1:1 year using ../temp/cpi2012.dta, nogen keep(1 3)
 18.         foreach v in medrentprice_SFCC safmr {
 19.                 replace `v' = `v'/cpi2012
 20.         }
 21.         
.         corr safmr medrentprice_SFCC
 22. 
.         twoway (line medrentprice_SFCC year, lc(eltblue)) ///
>                    (line safmr year, lp(dash) lc(gs10)), ///
>                    legend(order(1 "zillow single family/condo" 2 "SAFMR")) //
> /
>                    ylabel(500(500)2000, grid labsize(small)) ytitle("Rent (20
> 12 USD)", size(medsmall)) ///
>                    xlabel(, labsize(small))  xtitle(, size(medsmall)) ///
>                    graphregion(color(white)) bgcolor(white)
 23.         graph export "../output/trend_zillow_safmrwgt_zipcode_avg.png", re
> place
 24.         restore 
 25.         * Option 1: take year average 
.         preserve
 26.         collapse (mean) medrentprice_SFCC, by(zipcode year)
 27.         merge 1:1 zipcode year using "../temp/safmr.dta"
 28. 
.         unab safmrvars: safmr*
 29.         collapse (mean) medrentprice_SFCC `safmrvars', by(year)
 30. 
.         merge 1:1 year using "../temp/cpi2012.dta", nogen keep(1 3)
 31.         foreach v in  medrentprice_SFCC `safmrvars' {
 32.                 replace `v' = `v'/cpi2012
 33.         }
 34. 
.         twoway (line medrentprice_SFCC year, lc(eltblue)) ///
>                    (line safmr2br year, lp(dash) lc(gs11)) ///
>                    (line safmr3br year, lp(dash) lc(lavender)) ///
>                    (line safmr4br year, lp(dash) lc(black)), ///
>                    legend(order(1 "zillow single family/condo" 2 "SAFMR 2br" 
> 3 "SAFMR 3br" 4 "SAFMR 4br") cols(3)) ///
>                    ylabel(, grid labsize(small)) ytitle("Rent (2012 USD)", si
> ze(medsmall)) ///
>                    xlabel(, labsize(small)) xtitle(, size(medsmall)) ///
>                    graphregion(color(white)) bgcolor(white)
 35.         graph export "../output/trend_zillow_safmr_zipcode_avg.png", repla
> ce
 36. 
.         twoway (line medrentprice_SFCC year, lc(eltblue)) ///
>                    (line safmr3br year, lp(dash) lc(black)), ///
>                    legend(order(1 "zillow single family/condo" 2 "SAFMR 3br")
>  cols(3)) ///
>                    ylabel(, grid labsize(small)) ytitle("Rent (2012 USD)", si
> ze(medsmall)) ///
>                    xlabel(, labsize(small)) xtitle(, size(medsmall)) ///
>                    graphregion(color(white)) bgcolor(white)
 37.         graph export "../output/trend_zillow_safmr3br_zipcode_avg.png", re
> place
 38. 
.         restore
 39. 
.         * Option 2: take given month 
.         foreach m in `mlist' {
 40.                 preserve
 41.                 g month = month(dofm(year_month))
 42. 
.                 keep if month == `m'
 43.                 merge 1:1 zipcode year using "../temp/safmr.dta"        
 44. 
. 
.                 unab safmrvars: safmr*
 45.                 collapse (mean)  medrentprice_SFCC `safmrvars', by(year)
 46. 
.                 merge 1:1 year using "../temp/cpi2012.dta", nogen keep(1 3)
 47.                 foreach v in medrentprice_SFCC {
 48.                         replace `v' = `v'/cpi2012
 49.                 }
 50. 
.                 twoway (line medrentprice_SFCC year, lc(eltblue)) ///
>                            (line safmr2br year, lp(dash) lc(gs11)) (line safm
> r3br year, lp(dash) lc(lavender)) (line safmr4br year, lp(dash) lc(black)), /
> //
>                            legend(order(1 "zillow single family/condo" 2 "SAF
> MR 2br" 3 "SAFMR 3br" 4 "SAFMR 4br") cols(3)) ///
>                            ylabel(, grid labsize(small)) ytitle("Rent (2012 U
> SD)", size(medsmall)) ///
>                            xlabel(, labsize(small)) xtitle(, size(medsmall)) 
> ///
>                            graphregion(color(white)) bgcolor(white)
 51.                 graph export ../output/trend_zillow_safmr_zipcode_m`m'.png
> , replace
 52. 
.                 twoway (line medrentprice_SFCC year, lc(eltblue)) ///
>                            (line safmr3br year, lp(dash) lc(black)), ///
>                            legend(order(1 "zillow single family/condo" 2 "SAF
> MR 3br") cols(3)) ///
>                            ylabel(, grid labsize(small)) ytitle("Rent (2012 U
> SD)", size(medsmall)) ///
>                            xlabel(, labsize(small)) xtitle(, size(medsmall)) 
> ///
>                            graphregion(color(white)) bgcolor(white)
 53.                 graph export "../output/trend_zillow_safmr3br_zipcode_m`m'
> .png", replace
 54.                 restore 
 55.         }
 56. 
.         *binscatter correlation         
.         collapse (mean) medrentprice_SFCC, by(zipcode year)
 57.         merge 1:1 zipcode year using "../temp/safmr.dta"        
 58. 
.         reshape long safmr@br, i(zipcode year medrentprice_SFCC) j(safmr_type
> )
 59. 
.         * zipcode average time series correlations
.         preserve 
 60.                 collapse (mean) medrentprice_SFCC safmrbr, by(year safmr_t
> ype)
 61.                 bys safmr_type: corr medrentprice_SFCC safmrbr
 62.         restore
 63. 
.         winsor2 medrentprice_SFCC, replace by(safmr_type year) cuts(5 95)
 64. 
.         preserve
 65.         local nbr = 3
 66.         foreach var in medrentprice_SFCC safmrbr {
 67.                 qui reghdfe `var' if safmr_type==`nbr', absorb(zipcode) re
> s(`var'R)
 68.         }
 69.         qui corr medrentprice_SFCCR safmrbrR if safmr_type==`nbr'
 70.         local rho = round(r(rho), .001)
 71.         di `rho'
 72. 
.         qui reghdfe medrentprice_SFCC safmrbr if safmr_type==`nbr', absorb(zi
> pcode)
 73.         local estbeta = round(_b[safmrbr], .001)
 74.         local estse = round(_se[safmrbr], .001)
 75.         binscatter medrentprice_SFCC safmrbr if safmr_type==`nbr', ///
>         absorb(zipcode) ///
>         ytitle("Median Rent Price (2012 USD)", size(medsmall)) xtitle("Small 
> Area Fair Market Rent - `nbr'br", size(medsmall)) ///
>         mc(navy) lc(gs10) text(1600 2200 "{&beta} = `estbeta' (`estse')") tex
> t(1580 2150 "{&rho} = `rho'")
 76. 
.         graph export "../output/bins_sfcc_safmr`nbr'br.png", replace
 77.         restore
 78. end

. 
. 
. main 
(2 vars, 10 obs)
(10 real changes made)
(note: file ../temp/cpi2012.dta not found)
file ../temp/cpi2012.dta saved
(5 vars, 100 obs)
       panel variable:  br (strongly balanced)
        time variable:  year, 2011 to 2019, but with gaps
                delta:  1 unit
br_share:  (20 real changes made)
(note: file ../temp/ahs_wgt.dta not found)
file ../temp/ahs_wgt.dta saved
(note: file ../temp/safmr_2017_2019.dta not found)
file ../temp/safmr_2017_2019.dta saved
(note: file ../temp/safmr.dta not found)
file ../temp/safmr.dta saved
(note: j = 1 2 3 4)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                        8   ->      32
Number of variables                   5   ->       3
j variable (4 values)                     ->   br
xij variables:
         safmr1br safmr2br ... safmr4br   ->   safmrbr
-----------------------------------------------------------------------------

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                                32  
    -----------------------------------------
(analytic weights assumed)
(note: file ../temp/wgt_safmr.dta not found)
file ../temp/wgt_safmr.dta saved
performance warning: -by- prefix may be slower than -by()-
rowtotal() is not a gtools function and no by(); falling back on egen
(4,446,000 observations deleted)
(0 observations deleted)

    Result                           # of obs.
    -----------------------------------------
    not matched                             2
        from master                         2  
        from using                          0  

    matched                                 8  
    -----------------------------------------

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                                10  
    -----------------------------------------
(9 real changes made)
(7 real changes made)
(obs=8)

             |    safmr medren~C
-------------+------------------
       safmr |   1.0000
medrentpri~C |   0.6175   1.0000

(note: file ../output/trend_zillow_safmrwgt_zipcode_avg.png not found)
(file ../output/trend_zillow_safmrwgt_zipcode_avg.png written in PNG format)

    Result                           # of obs.
    -----------------------------------------
    not matched                       159,118
        from master                     7,629  (_merge==1)
        from using                    151,489  (_merge==2)

    matched                            26,741  (_merge==3)
    -----------------------------------------

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                                10  
    -----------------------------------------
(9 real changes made)
(7 real changes made)
(7 real changes made)
(7 real changes made)
(7 real changes made)
(note: file ../output/trend_zillow_safmr_zipcode_avg.png not found)
(file ../output/trend_zillow_safmr_zipcode_avg.png written in PNG format)
(note: file ../output/trend_zillow_safmr3br_zipcode_avg.png not found)
(file ../output/trend_zillow_safmr3br_zipcode_avg.png written in PNG format)
(378,070 observations deleted)

    Result                           # of obs.
    -----------------------------------------
    not matched                       159,118
        from master                     7,629  (_merge==1)
        from using                    151,489  (_merge==2)

    matched                            26,741  (_merge==3)
    -----------------------------------------

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                                10  
    -----------------------------------------
(8 real changes made)
(note: file ../output/trend_zillow_safmr_zipcode_m1.png not found)
(file ../output/trend_zillow_safmr_zipcode_m1.png written in PNG format)
(note: file ../output/trend_zillow_safmr3br_zipcode_m1.png not found)
(file ../output/trend_zillow_safmr3br_zipcode_m1.png written in PNG format)
(378,070 observations deleted)

    Result                           # of obs.
    -----------------------------------------
    not matched                       159,118
        from master                     7,629  (_merge==1)
        from using                    151,489  (_merge==2)

    matched                            26,741  (_merge==3)
    -----------------------------------------

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                                10  
    -----------------------------------------
(9 real changes made)
(note: file ../output/trend_zillow_safmr_zipcode_m6.png not found)
(file ../output/trend_zillow_safmr_zipcode_m6.png written in PNG format)
(note: file ../output/trend_zillow_safmr3br_zipcode_m6.png not found)
(file ../output/trend_zillow_safmr3br_zipcode_m6.png written in PNG format)
(378,070 observations deleted)

    Result                           # of obs.
    -----------------------------------------
    not matched                       159,118
        from master                     7,629  (_merge==1)
        from using                    151,489  (_merge==2)

    matched                            26,741  (_merge==3)
    -----------------------------------------

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                                10  
    -----------------------------------------
(9 real changes made)
(note: file ../output/trend_zillow_safmr_zipcode_m12.png not found)
(file ../output/trend_zillow_safmr_zipcode_m12.png written in PNG format)
(note: file ../output/trend_zillow_safmr3br_zipcode_m12.png not found)
(file ../output/trend_zillow_safmr3br_zipcode_m12.png written in PNG format)

    Result                           # of obs.
    -----------------------------------------
    not matched                       159,118
        from master                     7,629  (_merge==1)
        from using                    151,489  (_merge==2)

    matched                            26,741  (_merge==3)
    -----------------------------------------
(note: j = 1 2 3 4)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                   185859   ->  743436
Number of variables                   8   ->       6
j variable (4 values)                     ->   safmr_type
xij variables:
         safmr1br safmr2br ... safmr4br   ->   safmrbr
-----------------------------------------------------------------------------

-------------------------------------------------------------------------------
-> safmr_type = 1
(obs=8)

             | medren~C  safmrbr
-------------+------------------
medrentpri~C |   1.0000
     safmrbr |   0.7693   1.0000


-------------------------------------------------------------------------------
-> safmr_type = 2
(obs=8)

             | medren~C  safmrbr
-------------+------------------
medrentpri~C |   1.0000
     safmrbr |   0.8568   1.0000


-------------------------------------------------------------------------------
-> safmr_type = 3
(obs=8)

             | medren~C  safmrbr
-------------+------------------
medrentpri~C |   1.0000
     safmrbr |   0.8906   1.0000


-------------------------------------------------------------------------------
-> safmr_type = 4
(obs=8)

             | medren~C  safmrbr
-------------+------------------
medrentpri~C |   1.0000
     safmrbr |   0.9086   1.0000


.258
(note: file ../output/bins_sfcc_safmr3br.png not found)
(file ../output/bins_sfcc_safmr3br.png written in PNG format)
(note: j = 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                   743436   ->   97396
Number of variables                   5   ->      22
j variable (10 values)             year   ->   (dropped)
xij variables:
                      medrentprice_SFCC   ->   medrentprice_SFCC2010 medrentpri
> ce_SFCC2011 ... medrentprice_SFCC2019
                                safmrbr   ->   safmrbr2010 safmrbr2011 ... safm
> rbr2019
-----------------------------------------------------------------------------
(3,128 missing values generated)
(83,836 missing values generated)
warning: nquantiles(20) was specified, but only 18 were generated. see help fil
> e under nquantiles() for explanation.
(note: file ../output/binscatter_zillow_vs_safmr2br.png not found)
(file ../output/binscatter_zillow_vs_safmr2br.png written in PNG format)

. 
end of do-file

 make.py ended: 2021-10-27 14:28:08
