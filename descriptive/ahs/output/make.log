
 make.py started: 2023-07-04 13:01:22 C:\Users\shermo\Documents\GitHub\min_wage_rent\descriptive\ahs\code 




Execute:  R CMD BATCH --no-save "./prepare.R" prepare.Rout

R version 4.1.1 (2021-08-10) -- "Kick Things"
Copyright (C) 2021 The R Foundation for Statistical Computing
Platform: x86_64-w64-mingw32/x64 (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> remove(list = ls())
> 
> library(dplyr)

Attaching package: 'dplyr'

The following objects are masked from 'package:stats':

    filter, lag

The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union

Warning message:
package 'dplyr' was built under R version 4.1.3 
> library(readr)
> 
> main <- function() {
+   in_data <- '../../../drive/base_large/ahs'
+   varchar <- c('smsa', 'county', 'state', 'household_id')
+   
+   hh_data <- load_hh_data(in_data)
+   
+   hh_data_renters <- load_hh_data(in_data, TRUE)
+   
+   hh_data_rent_sqft <- load_hh_data(in_data, TRUE, TRUE)
+   
+   person_data <- load_person_data(in_data, hh_data)
+   
+   sh_renters <- hh_data %>%
+     mutate(pr_tenant_res      = resid(lm(is_tenant ~ factor(smsa) , data = .)),
+            pr_tenant          = pr_tenant_res + mean(is_tenant)) %>%
+     group_by(hh_income_decile) %>%
+     summarise(pr_tenant = mean(pr_tenant),
+               n = unique(n))
+   
+   sh_unit_types <- hh_data_renters %>%
+     group_by(hh_income_decile, n_units_cat) %>%
+     summarise(count_unit_type = n(),
+               n = unique(n)) %>%
+     group_by(hh_income_decile) %>%
+     mutate(sh_unit_type = count_unit_type / sum(count_unit_type)) %>% 
+     select(-count_unit_type)
+   
+   sh_condo <- hh_data_renters %>%
+     mutate(sh_condo_res       = resid(lm(is_condo_coop ~ factor(smsa) , data = .)),
+            sh_condo           = sh_condo_res + mean(is_condo_coop)) %>%
+     group_by(hh_income_decile) %>%
+     summarise(sh_condo = mean(sh_condo),
+               n = unique(n))
+   
+   avg_sqft <- hh_data_rent_sqft %>%
+     mutate(unit_sqft_res      = resid(lm(unit_sqft ~ factor(smsa) , data = ., na.action=na.exclude)),
+            unit_sqft          = unit_sqft_res + mean(unit_sqft, na.rm=T)) %>%
+     group_by(hh_income_decile) %>%
+     summarise(avg_sqft = mean(unit_sqft, na.rm=T),
+               n = unique(n))
+   
+   avg_rent <- hh_data_rent_sqft %>%
+     mutate(monthly_hh_rent_res = resid(lm(monthly_hh_rent ~ factor(smsa) , data = ., na.action=na.exclude)),
+            monthly_hh_rent     = monthly_hh_rent_res + mean(monthly_hh_rent, na.rm=T)) %>%
+     group_by(hh_income_decile) %>%
+     summarise(avg_rent = mean(monthly_hh_rent, na.rm=T),
+               n = unique(n))
+   
+   avg_rent_psqft <- hh_data_rent_sqft %>%
+     mutate(rent_psqft     = monthly_hh_rent / unit_sqft, 
+            rent_psqft_res = resid(lm(rent_psqft ~ factor(smsa) , data = ., na.action=na.exclude)),
+            rent_psqft     = rent_psqft_res + mean(rent_psqft, na.rm=T)) %>%
+     group_by(hh_income_decile) %>%
+     summarise(avg_rent_psqft = mean(rent_psqft, na.rm=T),
+               n = unique(n))
+   
+   sh_hh_head <- person_data  %>% 
+     group_by(household_id) %>%
+     mutate(max_income   =  max(person_salary),
+            hh_head_max  =  1 * (person_salary == max_income)) %>%
+     ungroup %>% 
+     mutate(person_salary_res      = resid(lm(person_salary ~ factor(smsa) , data = .)),
+            person_salary_decile   = ntile(person_salary_res, 10),
+            hh_head_max_res        = resid(lm(hh_head_max ~ factor(smsa) , data = .)),
+            hh_head_max            = hh_head_max_res + mean(hh_head_max)) %>%
+     group_by(person_salary_decile) %>%
+     summarise(sh_hh_head_max = mean(hh_head_max),
+               n = unique(n))
+   
+   plots <- c('sh_renters', 'sh_unit_types', 'sh_condo', 'sh_hh_head', 'avg_rent',
+              'avg_sqft', 'avg_rent_psqft')
+   for (pp in plots) {
+     write_csv(get(pp), paste0('../output/', pp, '.csv'))
+   }
+   
+ }
> 
> load_hh_data <- function(path, renters_only = FALSE, rent_sqft = FALSE) {
+   data <- read_csv(file.path(path, 'household_2011_2013.csv'))
+   
+   data <- data %>%
+     filter(is_owner == 1 | is_tenant == 1,
+            hh_income > 0,
+            house_apartment_unit == 1)
+   
+   if (renters_only) {
+     data <- data %>%
+       filter(is_tenant == 1)
+   }
+   
+   if (rent_sqft) {
+     data <- data %>%
+       filter(!is.na(unit_sqft),
+              !is.na(monthly_hh_rent))
+   }
+   
+   data <- data %>% 
+     mutate(hh_income_res      = resid(lm(hh_income ~ factor(smsa) , data = .)),
+            hh_income_decile   = ntile(hh_income_res, 10),
+            n = n())
+   return(data)
+ }
> 
> load_person_data <- function(path, hh_data) {
+   data <- read_csv(file.path(path, 'person_2011_2013.csv'))
+   
+   data <- data %>% 
+     left_join(hh_data[, c('household_id', 'is_tenant', 'house_apartment_unit', 'smsa')], 
+               by = 'household_id') %>%
+     filter(is_tenant             == 1,
+            house_apartment_unit  == 1,
+            person_salary         >  0) %>% 
+     mutate(n = n())
+   
+   return(data)
+ }
> 
> main()
Rows: 164188 Columns: 24
-- Column specification --------------------------------------------------------
Delimiter: ","
chr  (5): household_id, county, state, smsa, n_units_cat
dbl (19): metro, fam_income, hh_income, hh_wageincome_ind, monthly_hh_rent, ...

i Use `spec()` to retrieve the full column specification for this data.
i Specify the column types or set `show_col_types = FALSE` to quiet this message.
Rows: 164188 Columns: 24
-- Column specification --------------------------------------------------------
Delimiter: ","
chr  (5): household_id, county, state, smsa, n_units_cat
dbl (19): metro, fam_income, hh_income, hh_wageincome_ind, monthly_hh_rent, ...

i Use `spec()` to retrieve the full column specification for this data.
i Specify the column types or set `show_col_types = FALSE` to quiet this message.
Rows: 164188 Columns: 24
-- Column specification --------------------------------------------------------
Delimiter: ","
chr  (5): household_id, county, state, smsa, n_units_cat
dbl (19): metro, fam_income, hh_income, hh_wageincome_ind, monthly_hh_rent, ...

i Use `spec()` to retrieve the full column specification for this data.
i Specify the column types or set `show_col_types = FALSE` to quiet this message.
Rows: 359760 Columns: 9
-- Column specification --------------------------------------------------------
Delimiter: ","
chr (1): household_id
dbl (8): person_num, relation_to_hh_head, person_salary, age, educ_level, ye...

i Use `spec()` to retrieve the full column specification for this data.
i Specify the column types or set `show_col_types = FALSE` to quiet this message.
`summarise()` has grouped output by 'hh_income_decile'. You can override using
the `.groups` argument.
> 
> proc.time()
   user  system elapsed 
  13.85    1.68    9.14 


Execute:  StataMP-64 /e do "./plot.do"

  ___  ____  ____  ____  ____ (R)
 /__    /   ____/   /   ____/
___/   /   /___/   /   /___/   15.1   Copyright 1985-2017 StataCorp LLC
  Statistics/Data Analysis            StataCorp
                                      4905 Lakeway Drive
     MP - Parallel Edition            College Station, Texas 77845 USA
                                      800-STATA-PC        http://www.stata.com
                                      979-696-4600        stata@stata.com
                                      979-696-4601 (fax)

Single-user 32-core Stata perpetual license:
       Serial number:  501506205566
         Licensed to:  KU Leuven FEB (CES)
                       KU Leuven

Notes:
      1.  Stata is running in batch mode.
      2.  Unicode is supported; see help unicode_advice.
      3.  More than 2 billion observations are allowed; see help obs_advice.
      4.  Maximum number of variables is set to 5000; see help set_maxvar.


running c:\ado\personal\profile.do ...

. do ./plot.do 

. clear all

. set more off

. set scheme s2color, permanently
(set scheme preference recorded)

. 
. program main 
  1. 
.     make_plot, xvar(hh_income_decile) yvar(pr_tenant) y_title("Share of rente
> rs") ///
>         x_title("Residualized household income decile") color(navy%80) name(s
> h_renters)
  2. 
.     make_plot, xvar(hh_income_decile) yvar(sh_condo) y_title("Share of people
>  in condos & cooperatives") ///
>         x_title("Residualized household income decile") color(navy%80) name(s
> h_condo)
  3. 
.     make_plot, xvar(hh_income_decile) yvar(avg_rent) y_title("Residualized av
> erage rent ($)") ///
>         x_title("Residualized household income decile") color(navy%80) name(a
> vg_rent)
  4. 
.     make_plot, xvar(hh_income_decile) yvar(avg_sqft) y_title("Residualized av
> erage square footage") ///
>         x_title("Residualized household income decile") color(navy%80) name(a
> vg_sqft)
  5. 
.     make_plot, xvar(hh_income_decile) yvar(avg_rent_psqft) y_title("Residuali
> zed average rent per square foot ($)") ///
>         x_title("Residualized household income decile") color(navy%80) name(a
> vg_rent_psqft)
  6. 
.     make_plot, xvar(person_salary_decile) yvar(sh_hh_head_max) ///
>         y_title("Residualized probability of being household head") ///
>         x_title("Residualized individual income decile") color(navy%80) name(
> sh_hh_head)
  7. 
.     make_stacked_plot, xvar1(n_units_cat) xvar2(hh_income_decile) yvar(sh_uni
> t_type)   ///
>         y_title("Share of unit type") x_title("Residualized household income 
> decile")   ///
>         name(sh_unit_types)
  8. 
. end

. 
. program make_plot
  1.     syntax, xvar(str) yvar(str) y_title(str) ///
>         x_title(str) color(str) name(str) [width(int 2221) height(int 1615)]
  2. 
.     import delimited "../output/`name'.csv", clear
  3. 
.     graph bar `yvar', over(`xvar') ytitle(`y_title') ///
>         b1title(`x_title') graphregion(color(white)) bgcolor(white) bar(1, fc
> olor(`color'))
  4. 
.     graph export "../output/`name'_png.png", replace width(`width') height(`h
> eight')
  5.     graph export "../output/`name'.eps", replace
  6. 
. end

. 
. program make_stacked_plot
  1.     syntax, xvar1(str) xvar2(str) yvar(str) y_title(str) ///
>         x_title(str) name(str) [width(int 2221) height(int 1615)]
  2. 
.     import delimited "../output/`name'.csv", clear
  3. 
.     graph bar `yvar', over(`xvar1') over(`xvar2') ytitle(`y_title') ///
>         b1title(`x_title') graphregion(color(white)) bgcolor(white) ///
>         asyvars stack
  4. 
.     graph export "../output/`name'_png.png", replace width(`width') height(`h
> eight')
  5.     graph export "../output/`name'.eps", replace
  6. 
. end

. 
. main
(3 vars, 10 obs)
(note: file ../output/sh_renters_png.png not found)
(file ../output/sh_renters_png.png written in PNG format)
(note: file ../output/sh_renters.eps not found)
(file ../output/sh_renters.eps written in EPS format)
(3 vars, 10 obs)
(note: file ../output/sh_condo_png.png not found)
(file ../output/sh_condo_png.png written in PNG format)
(note: file ../output/sh_condo.eps not found)
(file ../output/sh_condo.eps written in EPS format)
(3 vars, 10 obs)
(note: file ../output/avg_rent_png.png not found)
(file ../output/avg_rent_png.png written in PNG format)
(note: file ../output/avg_rent.eps not found)
(file ../output/avg_rent.eps written in EPS format)
(3 vars, 10 obs)
(note: file ../output/avg_sqft_png.png not found)
(file ../output/avg_sqft_png.png written in PNG format)
(note: file ../output/avg_sqft.eps not found)
(file ../output/avg_sqft.eps written in EPS format)
(3 vars, 10 obs)
(note: file ../output/avg_rent_psqft_png.png not found)
(file ../output/avg_rent_psqft_png.png written in PNG format)
(note: file ../output/avg_rent_psqft.eps not found)
(file ../output/avg_rent_psqft.eps written in EPS format)
(3 vars, 10 obs)
(note: file ../output/sh_hh_head_png.png not found)
(file ../output/sh_hh_head_png.png written in PNG format)
(note: file ../output/sh_hh_head.eps not found)
(file ../output/sh_hh_head.eps written in EPS format)
(4 vars, 40 obs)
(note: file ../output/sh_unit_types_png.png not found)
(file ../output/sh_unit_types_png.png written in PNG format)
(note: file ../output/sh_unit_types.eps not found)
(file ../output/sh_unit_types.eps written in EPS format)

. 
end of do-file


Execute:  R CMD BATCH --no-save "./make_autofill_values.R" make_autofill_values.Rout

R version 4.1.1 (2021-08-10) -- "Kick Things"
Copyright (C) 2021 The R Foundation for Statistical Computing
Platform: x86_64-w64-mingw32/x64 (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> remove(list = ls())
> library(data.table)
Warning message:
package 'data.table' was built under R version 4.1.3 
> library(stringr)
Warning message:
package 'stringr' was built under R version 4.1.3 
> 
> source('../../../lib/R/write_command.R')
> 
> main <- function() {
+   in_values    <- "../output"
+   out_autofill <- "../output"
+   
+   data <- fread(file.path(in_values, "sh_renters.csv"))
+   
+   bottom_dec  <- 100 * round(data[hh_income_decile %in% c(1,2), 
+                                   .(mean = mean(pr_tenant))]$mean, 2)
+   top_dec     <- 100 * round(data[hh_income_decile %in% c(9,10), 
+                                   .(mean = mean(pr_tenant))]$mean, 2)
+   
+   text <- c(write_command("BottomDecPrRent", bottom_dec),
+             write_command("TopDecPrRent"   , top_dec))
+   
+   text <- paste(text, collapse = "")
+   
+   write.table(text,
+               file.path(out_autofill, "ahs_autofill.tex"),
+               quote = F, row.names = F, col.names = F)
+ }
> 
> main()
> 
> proc.time()
   user  system elapsed 
   0.54    0.20    1.20 

 make.py ended: 2023-07-04 13:01:44
